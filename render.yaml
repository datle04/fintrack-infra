services:
  # 1. REDIS
  - type: redis
    name: fintrack-redis
    region: singapore
    plan: free
    ipAllowList: []

  # 2. CHATBOT
  - type: web
    name: chatbot-service
    repo: https://github.com/datle04/chatbot-service # <--- SỬA LINK
    branch: main
    env: node
    plan: free
    region: singapore
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      - key: NODE_VERSION # <--- THÊM DÒNG NÀY
        value: 22.11.0
      # 1. Môi trường Production
      - key: NODE_ENV
        value: production

      # 2. Redis (Lấy tự động từ service fintrack-redis)
      # Nó sẽ thay thế 'redis://redis_server:6379' thành link thật của Render
      - key: REDIS_URL
        fromService:
          name: fintrack-redis
          type: redis
          property: connectionString

      # 3. Các biến bí mật (Nhập tay trên Dashboard)
      - key: JWT_SECRET
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: GEMINI_API_URL
        sync: false

      # 4. Link Backend (Nhập tay vì cần đuôi /api)
      # Sau khi backend chạy, bạn nhập: https://fintrack-backend.onrender.com/api
      - key: FINTRACK_API_URL
        sync: false

  # 3. BACKEND
  - type: web
    name: fintrack-backend
    repo: https://github.com/datle04/fintrack # <--- SỬA LINK
    branch: main
    env: node
    plan: free
    region: singapore
    # Lệnh build bao gồm cả copy file css
    buildCommand: npm install && npm run build && cp src/utils/tailwind-report.css dist/utils/
    startCommand: npm start
    envVars:
      - key: NODE_VERSION # <--- THÊM DÒNG NÀY
        value: 22.11.0
      # --- 1. CẤU HÌNH HỆ THỐNG CỐ ĐỊNH ---
      - key: NODE_ENV
        value: production
      - key: PUPPETEER_CACHE_DIR # Cần cho thư viện Puppeteer của bạn
        value: /opt/render/project/src/.cache
      - key: ACCESS_TOKEN_EXPIRY
        value: 15m
      - key: REFRESH_TOKEN_EXPIRY
        value: 7d
      - key: EMAIL_HOST
        value: smtp.gmail.com
      - key: EMAIL_PORT
        value: 587
      - key: CLOUDINARY_UPLOAD_PRESET
        value: FinTrack
      - key: GEMINI_API_URL
        value: https://api.gemini.example/v1

      # --- 2. KẾT NỐI REDIS (Tự động) ---
      - key: REDIS_URL
        fromService:
          name: fintrack-redis
          type: redis
          property: connectionString

      # --- 3. CÁC BIẾN BÍ MẬT (Nhập tay trên Dashboard) ---
      - key: MONGODB_URI
        sync: false
      - key: REFRESH_TOKEN_SECRET
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false
      - key: OPEN_EXCHANGE_RATES_APP_ID
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: EMAIL_USER
        sync: false
      - key: EMAIL_PASS
        sync: false

      # --- 4. FRONTEND URL (QUAN TRỌNG) ---
      # Biến này để xử lý CORS và link verify email.
      # Vì Frontend chưa có link, bạn phải để sync: false và cập nhật sau.
      - key: FRONTEND_URL
        sync: false

  # 4. FRONTEND
  - type: web
    name: fintrack-frontend
    repo: https://github.com/datle04/fintrack-frontend # <--- SỬA LINK
    branch: main
    env: static
    # SỬA LỖI 2: Đã xóa dòng "region: singapore"
    buildCommand: npm run build
    staticPublishPath: ./dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: NODE_VERSION # <--- THÊM DÒNG NÀY
        value: 22.11.0
      # Vì Frontend chạy ở Client nên CẦN Public URL.
      # Blueprint chưa hỗ trợ lấy Public URL tự động, nên phải nhập tay.

      - key: VITE_BACK_END_URL
        sync: false

      - key: VITE_CHATBOT_API_URL
        sync: false
